<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">

    <title>Heures</title>

    <script src="./bower_components/webcomponentsjs/webcomponents.js"></script>
    <!--link rel="import" href="./elements/element-hello.html"-->
    <link rel="import" href="./bower_components/paper-header-panel/paper-header-panel.html">
    <link rel="import" href="./bower_components/paper-toolbar/paper-toolbar.html">
    <link rel="import" href="./bower_components/iron-flex-layout/iron-flex-layout.html">
    <link rel="import" href="./bower_components/paper-item/paper-item.html">
    <link rel="import" href="./bower_components/paper-listbox/paper-listbox.html">
    <link rel="import" href="./bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
    <link rel="import" href="./bower_components/paper-card/paper-card.html">

    <script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyAbU4Ok7ufne_5sZt1CBuTe2jCGh2V9IAo",
            authDomain: "project-3010963349219589577.firebaseapp.com",
            databaseURL: "https://project-3010963349219589577.firebaseio.com",
            storageBucket: "project-3010963349219589577.appspot.com",
        };
        firebase.initializeApp(config);
    </script>

    <style is="custom-style">
        paper-header-panel {
            height: 500px;
        }
        .content {
            height: 2000px;
        }
        paper-toolbar {
            background-color: rgba(127, 226, 159, 0.24);
        }
        paper-card {
            width: 100%;
        }
    </style>
</head>

<body class="fullbleed">
    <paper-header-panel mode="standard" class="vertical layout fit">

        <paper-toolbar>
            <paper-dropdown-menu label="Mois">
                <paper-listbox id="idLbMois" class="dropdown-content">
                    <paper-item value="01">01 Janvier</paper-item>
                    <paper-item value="02">02 Février</paper-item>
                    <paper-item value="03">03 Mars</paper-item>
                    <paper-item value="04">04 Avril</paper-item>
                    <paper-item value="05">05 Mai</paper-item>
                    <paper-item value="06">06 Juin</paper-item>
                    <paper-item value="07">07 Juillet</paper-item>
                    <paper-item value="08">08 Août</paper-item>
                    <paper-item value="09">09 Septembre</paper-item>
                    <paper-item value="10">10 Octobre</paper-item>
                    <paper-item value="11">11 Novembre</paper-item>
                    <paper-item value="12">12 Décembre</paper-item>
                </paper-listbox>
            </paper-dropdown-menu>
            <paper-dropdown-menu label="Années">
                <paper-listbox id="idLbAnnee" class="dropdown-content">
                    <paper-item value="2015">2015</paper-item>
                    <paper-item value="2016">2016</paper-item>
                    <paper-item value="2017">2017</paper-item>
                </paper-listbox>
            </paper-dropdown-menu>
        </paper-toolbar>

        <div class="content fit">
            <paper-card heading="Garde">
                <div class="card-content">
                    <div id="idHoursListGarde"></div>
                    <div>
                        jour: <input id="idJourGarde"/>
                        <button onclick="setBeginHour('garde')">debut</button>
                        <button onclick="setEndHour('garde')">fin</button>
                    </div>
                </div>
                <!--div class="card-actions">
                    <paper-button>Share</paper-button>
                    <paper-button>Explore!</paper-button>
                </div-->
            </paper-card>
            <div style="height: 10px"></div>
            <paper-card heading="Ménage">
                <div class="card-content">
                    <div id="idHoursListMenage"></div>
                    <div>
                        jour: <input id="idJourMenage"/>
                        <input type="button" onclick="setBeginHour('menage')" value="debut"/>
                        <input type="button" onclick="setEndHour('menage')" value="fin"/>
                    </div>
                </div>
                <!--div class="card-actions">
                    <paper-button>Share</paper-button>
                    <paper-button>Explore!</paper-button>
                </div-->
            </paper-card>
        </div>
    </paper-header-panel>

    <script>
        function init() {

            var now = new Date();
            var date = now.toJSON();
            var yearMonth = date.split('T')[0].split('-');

            idLbAnnee.selectIndex(yearMonth[0]-2015);
            idLbAnnee.addEventListener("iron-select", function(){
                displayAll();
            });
            idLbMois.selectIndex(yearMonth[1]-1);
            idLbMois.addEventListener("iron-select", function(){
                displayAll();
            });
        }

        function displayAll() {
            displayHours('garde', 'idHoursListGarde');
            displayHours('menage', 'idHoursListMenage');
        }

        function getNowDate() {
            var now = new Date();
            var date = now.toJSON();
            var yearMonth = date.split('T')[0];
            return {
                yearMonth: yearMonth,
                date: date
            };
        }

        function setBeginHour(service) {
            var now = getNowDate();
            writeHour(service, now.yearMonth, 'begin', now.date);
        }

        function setEndHour(service) {
            var now = getNowDate();
            writeHour(service, now.yearMonth, 'end', now.date);
        }

        function writeHour(service, month, beginEnd, entry) {
            firebase.database().ref(service + '/' + month + '/' + beginEnd).set(entry);
        }
        
        function displayHours(service, listTag) {
            var startDate  = idLbAnnee.selectedItem.getAttribute("value") + '-' + idLbMois.selectedItem.getAttribute("value") + '-01';
            var endDate = idLbAnnee.selectedItem.getAttribute("value") + '-' + idLbMois.selectedItem.getAttribute("value") + '-31';
            firebase.database()
                    .ref(service)
                    .orderByKey()
                    .startAt(startDate)
                    .endAt(endDate)
                    .on('value', function(snapshot) {
                var list = window.document.getElementById(listTag);
                list.innerHTML = '';

                var value =  snapshot.val();
                for(var index in value) {
                    var attr = value[index];

                    var e = document.createElement('div');
                    var begin = new Date(attr.begin);
                    var end = new Date(attr.end);
                    var timeMinutes = Math.floor((end - begin)/(1000 * 60));
                    var hours = Math.floor(timeMinutes / 60);
                    var minutes = timeMinutes % 60;
                    e.innerHTML = index + ': ' + attr.begin + ' / ' + attr.end + ' = ' + ((hours<10) ? '0' : '') + hours + 'h' + ((minutes<10) ? '0' : '') + minutes;
                    list.appendChild(e);
                }
            });
        }

        init();
    </script>
</body>
</html>