<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="./hours-hour.html">
<link rel="import" href="./hdbase-service.html">

<dom-module id="hours-card">

    <template>
        <style is="custom-style">
            paper-card {
                padding-top: 10px;
                width: 100%;
            }
            .addButton {
                position: absolute;
                right: 15px;
                bottom: 15px;
            }
            paper-fab.green {
                --paper-fab-background: var(--paper-green-500);
                --paper-fab-keyboard-focus-background: var(--paper-green-900);
            }
        </style>

        <paper-card heading="{{name}}">
            <div class="card-content">
                <div id="idHours"></div>
                <div id="idTotalHours"></div>
                <paper-fab on-tap="_openDateDialog" icon="add" class="addButton green"></paper-fab>

                <paper-dialog id="idDateDialog" class="paper-date-picker-dialog" modal
                              on-iron-overlay-closed="dismissDialog">
                    <paper-date-picker id="idDatePicker" headingFormat="ddd D MMM" locale="fr"></paper-date-picker>
                    <div class="buttons">
                        <paper-button dialog-dismiss>Cancel</paper-button>
                        <paper-button on-tap="_createNewDate" dialog-confirm>OK</paper-button>
                    </div>
                </paper-dialog>
            </div>
            <!--div class="card-actions">
                <paper-button>Share</paper-button>
                <paper-button>Explore!</paper-button>
            </div-->
        </paper-card>

    </template>

    <script>
        Polymer({
            is: 'hours-card',

            ready: function () {
                //this._displayHours();
            },

            properties: {
                // declare properties for the element's public API
                name: {
                    type: String
                },
                service: {
                    type: String,
                    observer: '_displayHours'
                },
                month: {
                    type: String,
                    observer: '_displayHours'
                },
                year: {
                    type: String,
                    observer: '_displayHours'
                },
                totalHours: {
                    type: Number,
                    value: 0
                }
            },

            _openDateDialog: function() {
                this.$.idDateDialog.open();
            },
            dismissDialog: function() {
            },
            _format2digit: function( num) {
                return ((num < 10) ? '0' : '') + num;
            },
            _createNewDate: function() {
                // create time now
                var now = new Date();
                var newTime = this._format2digit(now.getHours()) + ':' + this._format2digit(now.getMinutes()) + ':00.000Z';

                // get date picked
                var dayPicked = this.$.idDatePicker.date.getDate();
                var newDate = this.year + '-' + this.month + '-' + this._format2digit(dayPicked);

                // todo: create hours-hour tag waiting db callback
                window.hDBase.setHour(this.service, newDate, 'begin', newDate + 'T' + newTime);
                window.hDBase.setHour(this.service, newDate, 'end', newDate + 'T' + newTime);
            },
            _displayHours: function() {
                var list = this.$.idHours;
                var startDate = this.year + '-' + this.month + '-01';
                var endDate = this.year + '-' + this.month + '-31';
                window.console.log('Display for month ' + this.month + ', year ' + this.year);

                var self = this;
                window.hDBase.getHours(this.service, startDate, endDate, function (snapshot) {
                    window.console.log('Update hours, received snapshot from DB for service "' + self.service + '"');
                    list.innerHTML = ''; // clear list before update with new values
                    var value = snapshot.val();
                    for (var index in value) {
                        var attr = value[index];

                        var e = document.createElement('div');
                        e.innerHTML = '<hours-hour start="' + attr.begin + '" end="' + attr.end + '" service="' + self.service + '"></hours-hour>';
                        list.appendChild(e);
                    }

                    // compute total hours for the month
                    var hours = 0;
                    for (var i = 0; i < list.children.length; i++) {
                        hours += list.children[i].firstChild.getMinutes();
                    }

                    self.$.idTotalHours.innerHTML = '<br>Total heures = ' + self._format2digit(Math.floor(hours / 60)) + 'h' + self._format2digit(hours % 60);
                });
            }

        });


    </script>

</dom-module>