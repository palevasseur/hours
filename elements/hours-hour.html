<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- todo: change with http://dotlouis.github.io/md-timepicker/components/md-timepicker/index.html-->
<!-- todo: or https://customelements.io/SoldovskijBB/paper-time-picker/ -->
<link rel="import" href="../bower_components/paper-time-picker/paper-time-picker.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="./hdbase-service.html">

<dom-module id="hours-hour">

    <template>
        <style>
            .time {
                border: solid 1px white;
                cursor: pointer;
                padding: 3px;
            }
            .clearButton {
                color: red;
                visibility: hidden;
            }
        </style>

        <div id="idHour" on-mouseover="_select" on-mouseout="_unselect">
            <span>{{_day}}:</span>
            <span id="idStartTime" class="time" on-tap="_handleTapStart">{{_timeStart}}</span>
            <span> - </span>
            <span id="idEndTime" class="time" on-tap="_handleTapEnd">{{_timeEnd}}</span>
            <span> = {{_hours}}</span>
            <paper-icon-button id="idClearButton" on-tap="_handleRemove" icon="clear" class="clearButton"></paper-icon-button>
        </div>
        <div id="idDialogContainer"></div>

    </template>

    <script>
        Polymer({
            is: 'hours-hour',
            ready: function () {
                this._refresh();
            },
            properties: {
                start: String,
                end: String,
                service: String,
                _day: String,
                _timeStart: String,
                _timeEnd: String,
                _hours: String,
                _editTime: String,
                _paperDialog: Object,
                _timePicker: Object
            },
            getMinutes: function() {
                var timeHM = this._computeHours(this.start, this.end, ':');
                var timeH = timeHM.split(':')[0];
                var timeM = timeHM.split(':')[1];
                return (parseInt(timeH) * 60 + parseInt(timeM));
            },
            _refresh: function () {
                this._day = this._getDay(this.start);
                this._timeStart = this._getTime(this.start);
                this._timeEnd = this._getTime(this.end);
                this._hours = this._computeHours(this.start, this.end, 'h');
            },
            _select: function () {
                this.$.idClearButton.style.visibility='visible';
                this.$.idStartTime.style.border = "solid 1px gainsboro";
                this.$.idEndTime.style.border = "solid 1px gainsboro";
            },
            _unselect: function () {
                this.$.idClearButton.style.visibility='hidden';
                this.$.idStartTime.style.border = "solid 1px white";
                this.$.idEndTime.style.border = "solid 1px white";
            },
            _createDialogTimePicker: function() {
                // todo: create timeDialog component
                if(this._paperDialog) {
                    return;
                }

                this._paperDialog = document.createElement('paper-dialog');
                this._paperDialog.modal = true;
                this._paperDialog.class = 'paper-time-picker-dialog';
                this.$.idDialogContainer.appendChild(this._paperDialog);

                this._timePicker = document.createElement('paper-time-picker');
                this._paperDialog.appendChild(this._timePicker);

                var divButtons = document.createElement('div');
                divButtons.class = 'buttons';
                this._paperDialog.appendChild(divButtons);

                var cancelButton = document.createElement('paper-button');
                cancelButton.innerText = 'Annuler';
                cancelButton.dialogDismiss = true;
                cancelButton.addEventListener('tap', this._handleCancel.bind(this));
                divButtons.appendChild(cancelButton);

                var okButton = document.createElement('paper-button');
                okButton.innerText = 'OK';
                okButton.addEventListener('tap', this._handleChangeTime.bind(this));
                okButton.dialogConfirm = true;
                divButtons.appendChild(okButton);
            },
            _createDialogConfirmDelete: function(text) {
                // todo: create confirmDialog component
                if(this._paperDialog) {
                    return;
                }

                this._paperDialog = document.createElement('paper-dialog');
                this._paperDialog.modal = true;
                this.$.idDialogContainer.appendChild(this._paperDialog);

                var message = document.createElement('div');
                message.innerText = text;
                this._paperDialog.appendChild(message);

                var divButtons = document.createElement('div');
                divButtons.class = 'buttons';
                this._paperDialog.appendChild(divButtons);

                var cancelButton = document.createElement('paper-button');
                cancelButton.innerText = 'Annuler';
                cancelButton.dialogDismiss = true;
                cancelButton.addEventListener('tap', this._handleCancel.bind(this));
                divButtons.appendChild(cancelButton);

                var okButton = document.createElement('paper-button');
                okButton.innerText = 'OK';
                okButton.addEventListener('tap', this._removeHour.bind(this));
                okButton.dialogConfirm = true;
                divButtons.appendChild(okButton);
            },
            _handleTapStart: function() {
                this._createDialogTimePicker();
                this._editTime = 'start';
                this._timePicker.time = this._getTime(this.start, ':');
                this._paperDialog.open();
            },
            _handleTapEnd: function() {
                this._createDialogTimePicker();
                this._editTime = 'end';
                this._timePicker.time = this._getTime(this.end, ':');
                this._paperDialog.open();
            },
            _handleRemove: function() {
                // todo: replace this.service by this.name
                this._createDialogConfirmDelete('Supprimer les heures de ' + this.service + ' du ' + this._day + ' ?');
                this._paperDialog.open();
            },
            _removeHour: function() {
                window.hDBase.removeHour(this.service, this.start.split('T')[0]);
            },
            _handleChangeTime: function() {
                var hours = this._timePicker.hour;
                var minutes = this._timePicker.minute;
                var time = ((hours < 10) ? '0' : '') + hours + ':' + ((minutes < 10) ? '0' : '') + minutes + ':00.000Z';
                this[this._editTime] = this[this._editTime].split('T')[0] + 'T' + time;
                this._refresh();
                // todo: refactor this.start => this.begin and remove here 'this._editTime=='start ? ...'
                window.hDBase.setHour(this.service, this[this._editTime].split('T')[0], this._editTime=='start' ? 'begin' : 'end', this[this._editTime]);
                this._closeDialog();
            },
            _handleCancel: function() {
                this._closeDialog();
            },
            _closeDialog: function() {
                this._paperDialog.close();

                // delete dialog
                this.$.idDialogContainer.removeChild(this._paperDialog);
                this._paperDialog = null;
                this._timePicker = null;
            },
            _computeHours: function (start, end, sep) {
                sep = sep || ':';
                var begin = new Date(start);
                var end = new Date(end);
                var timeMinutes = Math.floor((end - begin) / (1000 * 60));
                var hours = Math.floor(timeMinutes / 60);
                var minutes = timeMinutes % 60;
                return ((hours < 10) ? '0' : '') + hours + sep + ((minutes < 10) ? '0' : '') + minutes;
            },
            _getDay: function (date) {
                // 2016-07-24T17:13:21.687Z => 24
                return date.split('T')[0].split('-')[2];
            },
            _getTime: function (date, sep) {
                // 2016-07-24T17:13:21.687Z => 17:13
                var time = date.split('T')[1].split('.')[0].split(':');
                return time[0] + (sep || 'h') + time[1];
            }
        });
    </script>

</dom-module>